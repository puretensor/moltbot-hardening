# Firewall Rules for Moltbot/ClawdBot Host
#
# These rules restrict inbound traffic to Tailscale and SSH only.
# Apply with: sudo iptables-restore < firewall-rules.txt
#
# WARNING: Ensure you have console/IPMI access before applying.
#          Incorrect rules can lock you out.

*filter

# Default policies
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# Allow established and related connections
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow loopback (required for local services)
-A INPUT -i lo -j ACCEPT

# Allow Tailscale interface (all traffic from mesh)
-A INPUT -i tailscale0 -j ACCEPT

# Allow SSH on all interfaces (emergency access fallback)
# Remove this rule if SSH should only be via Tailscale
-A INPUT -p tcp --dport 22 -j ACCEPT

# Allow ICMP (ping) â€” useful for monitoring
-A INPUT -p icmp -j ACCEPT

# Log dropped packets (optional, can be noisy)
# -A INPUT -j LOG --log-prefix "IPTABLES-DROP: " --log-level 4

# Drop everything else (default policy)
COMMIT

# --- UFW Alternative ---
# If using UFW instead of raw iptables:
#
# sudo ufw default deny incoming
# sudo ufw default allow outgoing
# sudo ufw allow in on tailscale0
# sudo ufw allow ssh
# sudo ufw enable

# --- Verification ---
# After applying, verify:
#   sudo iptables -L -n -v
#   ss -tlnp
#   # Test SSH access from another machine
#   # Test Tailscale access
#   # Verify bot still functions
